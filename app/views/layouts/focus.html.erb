<!DOCTYPE html>
<html>
  <head>
    <title>Focus | Atelier0</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "tailwind", "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Shippori+Mincho:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <%# 【重要】Lucideアイコンライブラリの読み込み %>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      * { font-family: 'Poppins', 'Noto Sans JP', sans-serif !important; }
      #main-paper.f-sans  input, #main-paper.f-sans  textarea { font-family: 'Poppins', 'Noto Sans JP', sans-serif !important; }
      #main-paper.f-serif input, #main-paper.f-serif textarea { font-family: 'Shippori Mincho', serif !important; }
      #main-paper.f-round input, #main-paper.f-round textarea { font-family: 'Zen Maru Gothic', sans-serif !important; }

      #main-paper input { font-weight: 800 !important; }
      #main-paper textarea { line-height: 2.0 !important; }
      #main-paper.ts-s input    { font-size: 2.25rem !important; }
      #main-paper.ts-s textarea { font-size: 1rem !important; }
      #main-paper.ts-m input    { font-size: 3.5rem !important; }
      #main-paper.ts-m textarea { font-size: 1.25rem !important; }
      #main-paper.ts-l input    { font-size: 4.5rem !important; }
      #main-paper.ts-l textarea { font-size: 1.625rem !important; }

      #main-paper.p-white { background-color: #ffffff !important; }
      #main-paper.p-beige { background-color: #FFFEF9 !important; }
      #main-paper.p-black { background-color: #121212 !important; border-color: #262626 !important; }
      #main-paper.p-black input, #main-paper.p-black textarea { color: #E5E5E5 !important; }

      #main-paper input, #main-paper textarea { transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1) !important; outline: none !important; }

      .mode-soft .focus-ui-bar { opacity: 0.1 !important; transition: opacity 0.8s !important; }
      .mode-soft .focus-ui-bar:hover { opacity: 1 !important; }
      .mode-hard .focus-ui-bar { opacity: 0 !important; pointer-events: none !important; transition: opacity 0.8s !important; }
      body.reveal-nav .focus-ui-bar { opacity: 1 !important; pointer-events: auto !important; }

      .active-choice { color: #4F46E5 !important; font-weight: 800 !important; }
      .active-color { border: 3px solid #4F46E5 !important; }
      .memo-yellow { background-color: #FEF9C3 !important; }
      .memo-blue   { background-color: #DBEAFE !important; }
      .memo-pink   { background-color: #FCE7F3 !important; }
    </style>
  </head>

  <body id="focus-body" class="bg-[#F8FAFC] antialiased min-h-screen" data-controller="focus-sound memo">

    <div id="global-audio-container" data-turbo-permanent>
      <audio id="morphe-global-player" loop preload="none"></audio>
    </div>

    <main class="w-full min-h-screen flex flex-col items-center pt-24 pb-40 relative overflow-x-hidden">
      
      <div class="fixed top-6 left-6 z-[100] focus-ui-bar transition-all duration-700">
        <%= link_to root_path, class: "flex items-center justify-center w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-300 hover:text-indigo-500 shadow-sm" do %>
          <i data-lucide="x" class="w-5 h-5" stroke-width="1.5"></i>
        <% end %>
      </div>

      <div id="main-nav" class="focus-ui-bar fixed top-6 left-1/2 -translate-x-1/2 flex items-center gap-6 bg-white/95 backdrop-blur-md border border-slate-100 rounded-full px-7 py-3 shadow-2xl z-[150] whitespace-nowrap transition-all duration-700">
        
        <div class="flex items-center gap-1 border-r border-slate-100 pr-5">
          <button type="button" data-action="click->focus-sound#toggle" data-focus-sound-target="button" data-sound-type="rain" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 hover:text-indigo-500 transition-all">
            <i data-lucide="cloud-rain" class="w-5 h-5" stroke-width="1.5"></i>
          </button>
          <button type="button" data-action="click->focus-sound#toggle" data-focus-sound-target="button" data-sound-type="fire" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 hover:text-indigo-500 transition-all">
            <i data-lucide="flame" class="w-5 h-5" stroke-width="1.5"></i>
          </button>
          <button type="button" data-action="click->focus-sound#toggle" data-focus-sound-target="button" data-sound-type="coffee" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 hover:text-indigo-500 transition-all">
            <i data-lucide="coffee" class="w-5 h-5" stroke-width="1.5"></i>
          </button>
          <button type="button" data-action="click->focus-sound#toggle" data-focus-sound-target="button" data-sound-type="airplane" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 hover:text-indigo-500 transition-all">
            <i data-lucide="plane" class="w-5 h-5" stroke-width="1.5"></i>
          </button>
          <button type="button" data-action="click->focus-sound#toggle" data-focus-sound-target="button" data-sound-type="engine" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 hover:text-indigo-500 transition-all">
            <i data-lucide="car" class="w-5 h-5" stroke-width="1.5"></i>
          </button>
          <div class="w-px h-6 bg-slate-100 mx-1"></div>
          <button type="button" data-action="click->memo#toggle" data-memo-target="icon" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 transition-all">
            <i data-lucide="sticky-note" class="w-5 h-5" stroke-width="1.5"></i>
          </button>
        </div>

        <div class="flex items-center gap-6 border-r border-slate-100 pr-6">
          <div class="flex gap-2">
            <button id="btn-p-white" onclick="setPaper('p-white', this)" class="w-4 h-4 rounded-full bg-white border border-slate-200"></button>
            <button id="btn-p-beige" onclick="setPaper('p-beige', this)" class="w-4 h-4 rounded-full bg-[#FFFEF0] border border-slate-200"></button>
            <button id="btn-p-black" onclick="setPaper('p-black', this)" class="w-4 h-4 rounded-full bg-[#121212] border border-slate-800"></button>
          </div>
          <div class="flex flex-col items-center gap-1 border-l border-slate-100 pl-6">
            <span class="text-[7px] text-slate-300 font-bold uppercase tracking-widest">Font Style</span>
            <div class="flex gap-4">
              <button id="btn-f-sans" onclick="setFont('f-sans', this)" class="design-btn-font text-[11px] font-bold text-slate-300 uppercase hover:text-slate-900 transition-colors">Sans</button>
              <button id="btn-f-serif" onclick="setFont('f-serif', this)" class="design-btn-font text-[11px] font-bold text-slate-300 uppercase hover:text-slate-900 transition-colors">Serif</button>
              <button id="btn-f-round" onclick="setFont('f-round', this)" class="design-btn-font text-[11px] font-bold text-slate-300 uppercase hover:text-slate-900 transition-colors">Round</button>
            </div>
          </div>
          <div class="flex flex-col items-center gap-1 border-l border-slate-100 pl-6">
            <span class="text-[7px] text-slate-300 font-bold uppercase tracking-widest">Size</span>
            <div class="flex gap-4">
              <button id="btn-ts-s" onclick="setSize('ts-s', this)" class="design-btn-size text-[11px] font-bold text-slate-300 w-3 text-center hover:text-slate-900">S</button>
              <button id="btn-ts-m" onclick="setSize('ts-m', this)" class="design-btn-size text-[11px] font-bold text-slate-300 w-3 text-center hover:text-slate-900">M</button>
              <button id="btn-ts-l" onclick="setSize('ts-l', this)" class="design-btn-size text-[11px] font-bold text-slate-300 w-3 text-center hover:text-slate-900">L</button>
            </div>
          </div>
        </div>

        <div class="flex flex-col items-center gap-1 border-r border-slate-100 pr-6">
          <span class="text-[7px] text-slate-300 font-bold uppercase tracking-widest">View Mode</span>
          <div class="flex gap-4">
            <button id="btn-mode-none" onclick="setImmerse('none', this)" class="mode-btn text-[11px] font-bold text-slate-300 uppercase hover:text-slate-900">Normal</button>
            <button id="btn-mode-soft" onclick="setImmerse('soft', this)" class="mode-btn text-[11px] font-bold text-slate-300 uppercase hover:text-slate-900">Soft</button>
            <button id="btn-mode-hard" onclick="setImmerse('hard', this)" class="mode-btn text-[11px] font-bold text-slate-300 uppercase hover:text-slate-900">Deep</button>
          </div>
        </div>

        <div class="flex items-center">
          <%= form_with(model: @idea || Idea.new, data: { turbo: false }) do |form| %>
            <div class="hidden"><%= form.hidden_field :title, id: "hidden-title" %><%= form.hidden_field :description, id: "hidden-description" %></div>
            <%# ▼▼▼ 修正: 重複していた SAVE と end を削除し、きれいな形にしました ▼▼▼ %>
            <%= form.button id: "save-btn", class: "bg-slate-900 text-white px-7 py-3 rounded-full font-bold text-[12px] tracking-[0.2em] uppercase shadow-md transition-all duration-300 hover:bg-indigo-700 hover:shadow-lg", onclick: "startSaving()" do %>SAVE<% end %>
          <% end %>
        </div>
      </div>

      <div id="main-paper" class="w-full max-w-[1100px] p-white border border-slate-200 shadow-[0_30px_100px_rgba(0,0,0,0.04)] rounded-[4px] p-24 md:p-36 min-h-[1000px] flex flex-col relative transition-all duration-500 animate-fade-in-up ts-m f-sans">
        <div class="space-y-16 flex-1 flex flex-col pt-4">
          <input type="text" id="paper-title" value="<%= @idea&.title %>" placeholder="Untitled Idea" class="w-full bg-transparent border-none p-0 focus:ring-0">
          <textarea id="paper-description" placeholder="Start writing..." class="w-full h-full bg-transparent border-none p-0 focus:ring-0 resize-none min-h-[700px]"><%= @idea&.description %></textarea>
        </div>
      </div>

      <div id="memo-panel-ui" 
        data-controller="handwriting" 
        data-memo-target="panel" 
        class="fixed top-32 right-12 w-[700px] h-[500px] bg-white border border-slate-200 rounded-3xl shadow-2xl z-[200] translate-y-8 opacity-0 pointer-events-none transition-all duration-300 flex overflow-hidden">
  
      <%# 【左側】入力エリア %>
      <div class="w-[320px] h-full p-7 flex flex-col border-r border-slate-100 relative bg-white z-10">
    
        <%# ヘッダー %>
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
          <h2 class="font-bold text-slate-800 tracking-widest text-[10px] uppercase">Fragments</h2>
          <div class="flex gap-2">
            <button onclick="setMemoColor('memo-yellow')" type="button" class="w-4 h-4 rounded-full bg-[#FEF9C3] border border-slate-200 hover:scale-110 transition-transform"></button>
            <button onclick="setMemoColor('memo-blue')" type="button" class="w-4 h-4 rounded-full bg-[#DBEAFE] border border-slate-200 hover:scale-110 transition-transform"></button>
            <button onclick="setMemoColor('memo-pink')" type="button" class="w-4 h-4 rounded-full bg-[#FCE7F3] border border-slate-200 hover:scale-110 transition-transform"></button>
          </div>
        </div>

        <%# ▼▼▼ ここで分岐 ▼▼▼ %>
        <% if @idea&.persisted? %>
      
          <%# ① 保存済みの場合：いつもの入力フォームを表示 %>
          <%= form_with(model: [ @idea, Memo.new ], data: { turbo_stream: true, handwriting_target: "form" }, class: "flex-1 flex flex-col") do |f| %>
        
            <div class="flex flex-col gap-4 flex-1">
              <div id="memo-input-container" class="memo-yellow rounded-2xl p-4 shadow-inner transition-colors relative flex-1 flex flex-col">
                <%= f.hidden_field :color, id: "memo-color-field", value: "memo-yellow" %>
            
                <%= f.text_area :content, placeholder: "Type something...", class: "w-full bg-transparent border-none focus:ring-0 focus:outline-none p-0 text-sm resize-none flex-1 text-slate-700 leading-relaxed placeholder:text-slate-400/70 mb-2" %>

                <div class="flex items-center justify-between border-t border-black/5 pt-3 mt-auto">
                  <div class="flex items-center gap-2">
                    <button type="button" data-action="click->handwriting#startNew" class="text-xs flex items-center gap-1.5 text-slate-500 hover:text-indigo-600 transition-colors bg-white/50 px-3 py-1.5 rounded-lg border border-transparent hover:border-indigo-100 hover:bg-white">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                      <span>Draw</span>
                    </button>
                    <img data-handwriting-target="preview" class="hidden h-8 w-8 object-cover border border-white shadow-sm rounded bg-white ml-2" />
                  </div>
                </div>
                <%= f.hidden_field :handwriting_data, data: { handwriting_target: "input" } %>
              </div>

              <%= f.button class: "bg-indigo-600 text-white font-bold text-[10px] tracking-widest py-3 rounded-xl shadow-md hover:bg-indigo-700 hover:shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 mb-2" do %>
                <span>CLICK and ADD</span>
              <% end %>
            </div>
          <% end %>

        <% else %>

          <%# ② 未保存（新規作成中）の場合：ロック画面を表示 %>
          <div class="flex-1 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50 text-slate-400 p-6 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mb-3 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            <p class="font-bold text-xs text-slate-500 mb-1">Locked</p>
            <p class="text-[10px] leading-relaxed">
              First, enter the title and other details, <br>then save it.
            </p>
          </div>

        <% end %>
      </div>

      <%# 【右側】リストエリア %>
      <div class="flex-1 h-full bg-slate-50/50 p-6 relative">
        <div id="memos_list" class="h-full overflow-y-auto pr-2 scrollbar-hide space-y-4 pb-12">
          <% if @idea&.persisted? %>
            <%= render partial: "memos/memo", collection: @idea.memos.order(created_at: :desc) %>
          <% else %>
            <%# 未保存時はリストも空っぽだよ、という表示（任意） %>
            <div class="h-full flex items-center justify-center text-slate-300 text-xs">
              No memos yet.
            </div>
          <% end %>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
      </div>

      <%# モーダル（そのまま） %>
      <div data-handwriting-target="modal" class="hidden fixed inset-0 z-[9999] bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center animate-fade-in">
        <div class="absolute top-6 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-white border border-slate-200 shadow-lg px-6 py-3 rounded-full z-50">
          <div class="flex items-center gap-2">
            <button type="button" data-handwriting-target="penBtn" class="p-2 rounded-full text-slate-400 hover:bg-slate-100 transition-colors" title="Pen">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
            </button>
            <button type="button" data-handwriting-target="eraserBtn" class="p-2 rounded-full text-slate-400 hover:text-slate-700 transition-colors" title="Eraser">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>
            </button>
          </div>
           <div class="w-px h-6 bg-slate-200 mx-2"></div>
          <div class="flex items-center gap-2">
            <button type="button" data-handwriting-target="sizeBtn" data-size="2" class="w-8 h-8 rounded-full text-[10px] font-bold text-slate-400 hover:bg-slate-100 transition-colors">S</button>
            <button type="button" data-handwriting-target="sizeBtn" data-size="6" class="w-8 h-8 rounded-full text-[10px] font-bold text-slate-400 hover:bg-slate-100 transition-colors">M</button>
            <button type="button" data-handwriting-target="sizeBtn" data-size="12" class="w-8 h-8 rounded-full text-[10px] font-bold text-slate-400 hover:bg-slate-100 transition-colors">L</button>
          </div>
          <div class="w-px h-6 bg-slate-200 mx-2"></div>
          <button type="button" data-handwriting-target="clearBtn" class="p-2 text-slate-400 hover:text-red-500 transition-colors" title="Clear All">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
          </button>
          <button type="button" data-handwriting-target="saveBtn" class="ml-3 flex items-center gap-2 bg-indigo-600 text-white px-6 py-2 rounded-full text-xs font-bold tracking-widest hover:bg-indigo-700 transition-all shadow-md">DONE</button>
          <button type="button" data-handwriting-target="closeBtn" class="p-2 text-slate-400 hover:text-slate-700 transition-colors ml-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
          </button>
        </div>
        <canvas data-handwriting-target="canvas" class="w-full h-full cursor-crosshair touch-none"></canvas>
      </div>
    </div>
  </main>

  <script>
      // ▼▼▼ 1. 保存ボタンの制御 ▼▼▼
      function startSaving() {
        const title = document.getElementById('paper-title');
        const desc = document.getElementById('paper-description');
        const hTitle = document.getElementById('hidden-title');
        const hDesc = document.getElementById('hidden-description');

        if (title && hTitle) hTitle.value = title.value;
        if (desc && hDesc) hDesc.value = desc.value;

        const btn = document.getElementById('save-btn');
        if (btn) {
          btn.innerHTML = '<svg class="animate-spin h-4 w-4 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
          btn.classList.remove('bg-slate-900', 'hover:bg-slate-700', 'hover:shadow-lg');
          btn.classList.add('bg-indigo-600', 'cursor-wait', 'opacity-90');
          btn.style.pointerEvents = 'none';
        }
      }

  // ▼▼▼ 2. 付箋の色変更（これは絶対に必要！） ▼▼▼
      function setMemoColor(cls) {
        const container = document.getElementById('memo-input-container');
        const field = document.getElementById('memo-color-field');

    // コンテナがある場合のみクラスを変更（エラー防止）
        if (container) {
      // 既存の色クラスを削除して新しい色を追加
          container.classList.remove('memo-yellow', 'memo-blue', 'memo-pink');
          container.classList.add(cls);
        }

    // フォームの隠しフィールドに色情報をセット
        if (field) {
          field.value = cls;
        }
        localStorage.setItem('atelier0_memo_color', cls);
      }

  // ▼▼▼ 3. デザイン・没入モード設定 ▼▼▼
      function setImmerse(mode, btn) {
        const body = document.getElementById('focus-body');
        if (!body) return;

        body.classList.remove('mode-soft', 'mode-hard');
        if (mode !== 'none') {
          body.classList.add('mode-' + mode);
        }

        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-choice'));
        if (btn) btn.classList.add('active-choice');
        localStorage.setItem('atelier0_immerse', mode);
      }

      function setPaper(cls, btn) {
        const p = document.getElementById('main-paper');
        if (!p) return;
        p.classList.remove('p-white', 'p-beige', 'p-black');
        p.classList.add(cls);
        localStorage.setItem('atelier0_paper', cls);
        updateVisuals();
      }

      function setFont(cls, btn) {
        const p = document.getElementById('main-paper');
        if (!p) return;
        p.classList.remove('f-sans', 'f-serif', 'f-round');
        p.classList.add(cls);
        localStorage.setItem('atelier0_font', cls);
        updateVisuals();
      }

      function setSize(cls, btn) {
        const p = document.getElementById('main-paper');
        if (!p) return;
        p.classList.remove('ts-s', 'ts-m', 'ts-l');
        p.classList.add(cls);
        localStorage.setItem('atelier0_size', cls);
        updateVisuals();
      }

  // ▼▼▼ 4. 画面読み込み時の復元処理 ▼▼▼
      function updateVisuals() {
        const paper = localStorage.getItem('atelier0_paper') || 'p-white';
        const font = localStorage.getItem('atelier0_font') || 'f-sans';
        const size = localStorage.getItem('atelier0_size') || 'ts-m';
        const memoColor = localStorage.getItem('atelier0_memo_color') || 'memo-yellow';
        const immerse = localStorage.getItem('atelier0_immerse') || 'none';

        document.querySelectorAll('[id^="btn-p-"]').forEach(b => b.classList.remove('active-color'));
        const paperBtn = document.getElementById('btn-' + paper);
        if (paperBtn) paperBtn.classList.add('active-color');

        document.querySelectorAll('.design-btn-font, .design-btn-size').forEach(b => b.classList.remove('active-choice'));
        const fontBtn = document.getElementById('btn-' + font);
        if (fontBtn) fontBtn.classList.add('active-choice');

        const sizeBtn = document.getElementById('btn-' + size);
        if (sizeBtn) sizeBtn.classList.add('active-choice');

        const p = document.getElementById('main-paper');
        if (p) {
          p.classList.remove('p-white', 'p-beige', 'p-black', 'f-sans', 'f-serif', 'f-round', 'ts-s', 'ts-m', 'ts-l');
          p.classList.add(paper, font, size);
        }

    // メモの色を復元
        setMemoColor(memoColor);

        const immerseBtn = document.getElementById('btn-mode-' + immerse);
        if (immerseBtn) setImmerse(immerse, immerseBtn);

        if (window.lucide) {
          lucide.createIcons();
        }
      }

  // キーボードショートカット（Command + S）
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 's') {
          e.preventDefault();
          const saveBtn = document.getElementById('save-btn');

          if (saveBtn && !saveBtn.disabled) {
            startSaving();
            saveBtn.click();
          }
        }
      });

  // UIバーの表示制御
      document.addEventListener('mousemove', (e) => {
        const body = document.getElementById('focus-body');
        if (!body) return;

        if (e.clientY < 60) {
           body.classList.add('reveal-nav');
        } else if (!e.target.closest('.focus-ui-bar')) {
           body.classList.remove('reveal-nav');
        }
      });

      document.addEventListener('turbo:load', updateVisuals);
  // 初回読み込み対策
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateVisuals);
      } else {
        updateVisuals();
      }
    </script>
  </body>
</html>