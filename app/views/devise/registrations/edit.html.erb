<div class="min-h-screen py-20 px-4 flex items-center justify-center relative bg-slate-50">
  
  <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
    <div class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-indigo-200/20 rounded-full blur-[80px]"></div>
    <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-amber-100/40 rounded-full blur-[80px]"></div>
  </div>

  <div class="relative w-full max-w-2xl bg-white border border-slate-200 shadow-xl shadow-slate-200/50 rounded-3xl overflow-hidden">
    
    <div class="bg-white border-b border-slate-100 p-8 flex items-center justify-between">
      <div>
        <h2 class="font-['Poppins'] font-bold text-2xl text-slate-900">Edit Profile</h2>
        <p class="text-slate-500 text-xs font-['Inter'] mt-1">Customize your public persona.</p>
      </div>
      <%= link_to user_profile_path(resource.username), class: "w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 hover:text-slate-600 transition-colors" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      <% end %>
    </div>

    <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put, class: "p-8 md:p-10", multipart: true }) do |f| %>
      <%= render "devise/shared/error_messages", resource: resource %>

      <div class="flex flex-col md:flex-row gap-10">
        
        <div class="w-full md:w-1/3 flex flex-col items-center" data-controller="image-preview">
          <div class="relative group cursor-pointer mb-4">
            <div class="w-32 h-32 rounded-full overflow-hidden bg-slate-100 border-4 border-white shadow-lg relative ring-1 ring-slate-100">
              
              <%# エラー回避: 保存済み画像チェック %>
              <% show_avatar = resource.avatar.attached? && resource.avatar.blob&.persisted? %>
              
              <%= image_tag show_avatar ? resource.avatar : "", 
                  class: "w-full h-full object-cover absolute inset-0 z-10 #{'hidden' unless show_avatar}",
                  data: { image_preview_target: "output" } %>

              <div data-image-preview-target="placeholder" class="w-full h-full flex items-center justify-center bg-indigo-50 text-indigo-300 text-4xl font-bold absolute inset-0 <%= 'hidden' if show_avatar %>">
                <%= resource.username&.first&.upcase || "?" %>
              </div>
              
              <div class="absolute inset-0 bg-black/40 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 z-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-[10px] font-bold text-white uppercase tracking-wider">Change</span>
              </div>
            </div>
            
            <%= f.file_field :avatar, 
                class: "absolute inset-0 w-full h-full opacity-0 cursor-pointer z-30",
                data: { 
                  image_preview_target: "input",
                  action: "change->image-preview#preview" 
                } %>
          </div>
          <p class="text-[10px] text-slate-400 text-center px-4">
            Recommended: Square JPG, PNG. <br> Max 5MB.
          </p>
        </div>

        <div class="w-full md:w-2/3 space-y-8">
          
          <div class="space-y-5">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2 mb-4">Basic Info</h3>
            
            <div class="space-y-1.5">
              <%= f.label :username, class: "text-xs font-bold text-slate-700 ml-1" %>
              <%= f.text_field :username, class: "w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all font-['Poppins'] text-sm text-slate-700 placeholder:text-slate-300" %>
            </div>
            
            <div class="space-y-1.5">
              <%= f.label :email, class: "text-xs font-bold text-slate-700 ml-1" %>
              <%= f.email_field :email, autocomplete: "email", class: "w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all font-['Inter'] text-sm text-slate-700" %>
            </div>
          </div>

          <div class="space-y-5">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2 mb-4 flex justify-between items-center">
              <span>Security</span>
            </h3>
            
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 space-y-4">
              <p class="text-[10px] text-slate-400 mb-2">
                Leave these blank if you don't want to change your password.
              </p>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1.5">
                   <%= f.label :password, "New Password", class: "text-xs font-bold text-slate-700 ml-1" %>
                   <%= f.password_field :password, autocomplete: "new-password", placeholder: "Min 6 chars", class: "w-full px-4 py-2.5 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm" %>
                </div>

                <div class="space-y-1.5">
                  <%= f.label :password_confirmation, "Confirm", class: "text-xs font-bold text-slate-700 ml-1" %>
                  <%= f.password_field :password_confirmation, autocomplete: "new-password", placeholder: "Type again", class: "w-full px-4 py-2.5 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm" %>
                </div>
              </div>

              <div class="space-y-1.5 pt-2 border-t border-slate-200/50">
                <%= f.label :current_password, class: "text-xs font-bold text-slate-700 ml-1 flex items-center justify-between" do %>
                  <span>Current Password</span>
                  <span class="text-[9px] text-rose-500 font-normal">* Required only for password change</span>
                <% end %>
                <%= f.password_field :current_password, autocomplete: "current-password", placeholder: "Enter current password to confirm changes", class: "w-full px-4 py-2.5 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm" %>
              </div>
            </div>
          </div>

          <div class="pt-6 flex items-center justify-between">
            <%= button_to "Delete Account", registration_path(resource_name), data: { confirm: "Are you sure? This cannot be undone.", turbo_confirm: "Are you sure?" }, method: :delete, class: "text-xs font-bold text-rose-400 hover:text-rose-600 transition-colors px-2" %>
            
            <div class="flex items-center gap-4">
              <%= link_to "Cancel", :back, class: "text-xs font-bold text-slate-400 hover:text-slate-600 transition-colors" %>
              <%= f.submit "Save Changes", class: "px-8 py-2.5 bg-slate-900 text-white rounded-full font-['Poppins'] font-bold text-xs hover:bg-indigo-600 hover:shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-0.5 transition-all duration-300 cursor-pointer" %>
            </div>
          </div>

        </div>
      </div>
    <% end %>
  </div>
</div>