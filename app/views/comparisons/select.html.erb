<div class="max-w-6xl mx-auto md:py-10 px-4 min-h-screen">
  
  <div class="text-center mb-12">
    <p class="text-xs font-bold tracking-widest text-slate-400 uppercase mb-2">Compare Studio</p>
    <h1 class="text-3xl font-['Poppins'] font-bold text-slate-800">
      <% if @base_fragment %>
        Select a Partner for <span class="text-indigo-600 border-b-2 border-indigo-200"><%= @base_fragment.title.presence || "Untitled" %></span>
      <% else %>
        Select a Fragment for <span class="text-indigo-600 border-b-2 border-indigo-200">Slot <%= @target.upcase %></span>
      <% end %>
    </h1>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
    
    <% @candidates.each do |candidate| %>
      <% 
         # --- 魔法のロジック開始 ---
         
         # 1. すでに選んである「もう片方」がいるか確認
         current_kept_id = @other_id.presence || @base_fragment&.id

         if current_kept_id.present?
           # A. もう片方がいる場合 → 「完了！作成（POST）」へ進む
           target_url = comparisons_path
           target_method = :post
           
           if @target == 'a'
             final_params = { fragment_a_id: candidate.id, fragment_b_id: current_kept_id }
           else
             final_params = { fragment_a_id: current_kept_id, fragment_b_id: candidate.id }
           end

         else
           # B. まだ1枚目の場合 → 「次（もう片方）を選ぶ画面（GET）」へ進む
           target_url = select_comparisons_path
           target_method = :get
           
           # 次は逆サイド（AならB、BならA）を選ぶように指示
           next_target = (@target == 'a' ? 'b' : 'a')
           final_params = { target: next_target, keep_id: candidate.id }
         end
         # --- ロジック終了 ---
      %>
      
      <div class="group relative block bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 border border-slate-100">
        
        <div class="aspect-square bg-slate-100 relative overflow-hidden">
          <% if candidate.image.attached? %>
            <%= image_tag candidate.image, class: "w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" %>
          <% else %>
            <div class="w-full h-full flex items-center justify-center text-slate-300">
              <span class="text-xs font-bold">No Image</span>
            </div>
          <% end %>

          <div class="absolute inset-0 bg-indigo-900/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center backdrop-blur-[2px]">
            <span class="text-white font-['Poppins'] font-bold text-sm tracking-wider border border-white/30 px-4 py-2 rounded-full bg-white/10">SELECT</span>
          </div>
        </div>

        <div class="p-4">
          <h3 class="font-['Poppins'] font-bold text-slate-800 text-sm truncate"><%= candidate.title.presence || "Untitled" %></h3>
          <p class="text-[10px] text-slate-400 mt-1 font-['Space_Grotesk']">
            <%= candidate.created_at.strftime("%Y.%m.%d") %>
          </p>
        </div>

        <%= button_to target_url, 
              params: final_params, 
              method: target_method, 
              class: "absolute inset-0 w-full h-full z-10 opacity-0 cursor-pointer",
              form: { class: "absolute inset-0 w-full h-full z-10" } do %>
           <span class="sr-only">Select</span>
        <% end %>

      </div>
    <% end %>

  </div>
</div>