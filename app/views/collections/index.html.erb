<div class="w-full max-w-7xl mx-auto px-4 py-10 pb-20">

  <div class="flex items-center justify-between mb-10">
    <div class="flex items-center gap-4">
      <% back_link = @user ? user_profile_path(@user.username) : root_path %>
      <%= link_to back_link, class: "w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:border-indigo-200 transition-colors shadow-sm" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
      <% end %>

      <div>
        <h1 class="font-['Poppins'] font-bold text-2xl text-slate-900">
          <%= @page_title %>
        </h1>
        <p class="text-xs text-slate-500 font-['Inter'] mt-1">
          <%= @collections.count %> Collections
        </p>
      </div>
    </div>

    <% if @user == current_user %>
      <%= link_to new_collection_path, class: "flex items-center gap-2 px-5 py-2.5 bg-slate-900 text-white rounded-full text-xs font-bold hover:bg-indigo-600 transition-colors shadow-lg" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        <span>New Collection</span>
      <% end %>
    <% end %>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
    
    <% @collections.each do |collection| %>
      <% 
        # 表示できる画像を取得（権限考慮）
        visible_frags = if current_user == collection.user
          collection.fragments
        else
          collection.fragments.where.not(visibility: :private_view)
        end
      %>

      <div class="group relative">
        <%= link_to collection_path(collection), class: "block cursor-pointer" do %>
          
          <div class="relative aspect-square mb-3">
            <div class="absolute inset-0 bg-slate-100 border border-slate-100 rounded-2xl transform rotate-6 translate-x-2 translate-y-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="absolute inset-0 bg-slate-100 border border-slate-100 rounded-2xl transform rotate-3 translate-x-1 translate-y-1 opacity-100 transition-transform duration-300 group-hover:rotate-6 group-hover:translate-x-2 group-hover:translate-y-2">
               <% if visible_frags.offset(1).first&.image&.attached? %>
                 <%= image_tag visible_frags.offset(1).first.image, class: "w-full h-full object-cover rounded-2xl opacity-60" %>
               <% end %>
            </div>
            
            <div class="absolute inset-0 bg-white border border-slate-200 rounded-2xl shadow-sm group-hover:-translate-y-1 group-hover:-translate-x-1 group-hover:shadow-xl transition-all duration-300 overflow-hidden z-10">
              <% if visible_frags.first&.image&.attached? %>
                <%= image_tag visible_frags.first.image, class: "w-full h-full object-cover" %>
              <% else %>
                <div class="w-full h-full bg-slate-50 flex flex-col items-center justify-center text-slate-300">
                  <span class="font-bold text-2xl">?</span>
                </div>
              <% end %>
              
              <% if collection.private_view? %>
                <div class="absolute top-3 right-3 bg-black/60 text-white p-1.5 rounded-full backdrop-blur-md">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                </div>
              <% end %>
            </div>
          </div>
          
          <div class="px-1">
            <h3 class="font-['Poppins'] font-bold text-slate-800 text-sm group-hover:text-indigo-600 transition-colors line-clamp-1">
              <%= collection.title %>
            </h3>
            <p class="text-[10px] text-slate-400 font-['Space_Grotesk'] mt-1">
              <%= visible_frags.count %> items
            </p>
          </div>

        <% end %>
      </div>
    <% end %>

    <% if @collections.empty? %>
      <div class="col-span-full py-20 flex flex-col items-center justify-center text-center opacity-60">
        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-slate-300">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
        </div>
        <p class="font-['Poppins'] text-slate-400 font-medium text-sm">No collections yet.</p>
      </div>
    <% end %>

  </div>
</div>