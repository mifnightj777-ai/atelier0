<div class="min-h-screen bg-slate-50/50 pb-20">

  <%# --- 1. ZINEヘッダー --- %>
  <div class="relative w-full h-[40vh] md:h-[50vh] overflow-hidden bg-slate-900 flex items-center justify-center">
    <%# 背景のぼかし画像 (nilガード付) %>
    <% if @collection.fragments.first&.image&.attached? %>
      <%= image_tag @collection.fragments.first.image, class: "absolute inset-0 w-full h-full object-cover opacity-40 blur-xl scale-110" %>
    <% else %>
      <div class="absolute inset-0 bg-gradient-to-br from-slate-800 to-slate-900 opacity-50"></div>
    <% end %>

    <div class="relative z-10 text-center px-4 max-w-4xl mx-auto mt-10">
      <%# 公開設定バッジ %>
      <div class="mb-6">
        <% if @collection.private_view? %>
          <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-black/30 backdrop-blur border border-white/20 text-white text-[10px] font-bold uppercase tracking-widest">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            Private Collection
          </span>
        <% elsif @collection.teammates_view? %>
          <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-900/30 backdrop-blur border border-emerald-500/30 text-emerald-100 text-[10px] font-bold uppercase tracking-widest">
            Teammates Collection
          </span>
        <% end %>
      </div>

      <h1 class="text-4xl md:text-6xl font-['Poppins'] font-bold text-white mb-4 tracking-tight drop-shadow-lg">
        <%= @collection.title %>
      </h1>
      
      <% if @collection.description.present? %>
        <p class="text-slate-200 text-sm font-['Inter'] max-w-2xl mx-auto drop-shadow-md opacity-90">
          <%= @collection.description %>
        </p>
      <% end %>

      <div class="mt-8 flex items-center justify-center gap-2">
        <div class="w-8 h-8 rounded-full overflow-hidden border border-white/30">
          <% if @collection.user&.avatar&.attached? %>
            <%= image_tag @collection.user.avatar, class: "w-full h-full object-cover" %>
          <% else %>
            <div class="w-full h-full bg-white/20 flex items-center justify-center text-white font-bold text-xs">
              <%= @collection.user&.username&.first&.upcase || "?" %>
            </div>
          <% end %>
        </div>
        <span class="text-white/80 text-xs font-bold tracking-wide">by @<%= @collection.user&.username %></span>
      </div>
    </div>
  </div>

  <%# --- 2. 管理アクション（本人のみ） --- %>
  <% if user_signed_in? && current_user.id == @collection.user_id %>
    <div class="max-w-7xl mx-auto px-4 -mt-6 relative z-20 flex justify-end gap-3">
      <%= link_to edit_collection_path(@collection), class: "px-4 py-2 bg-white rounded-full text-xs font-bold text-slate-700 shadow-lg border border-slate-100 hover:text-indigo-600 transition-all flex items-center gap-2" do %>
        Edit Collection
      <% end %>
      <%= link_to new_collection_collection_item_path(@collection), class: "px-4 py-2 bg-slate-900 rounded-full text-xs font-bold text-white shadow-lg hover:bg-indigo-600 transition-all flex items-center gap-2" do %>
        <span>＋</span> Add Fragments
      <% end %>
    </div>
  <% end %>

  <%# --- 3. Fragments グリッド --- %>
  <div class="max-w-7xl mx-auto px-4 mt-16">
    <%# 門番メソッドで、閲覧者が見ていい画像だけを取得 %>
    <% visible_fragments = @collection.visible_fragments_for(current_user) %>

    <% if visible_fragments.any? %>
      <div class="columns-2 md:columns-3 lg:columns-4 gap-6 space-y-6">
        
        <%# 削除ボタンのために collection_items をループするが、中身は門番を通す %>
        <% @collection.collection_items.each do |item| %>
          <% fragment = item.fragment %>
          <% next unless visible_fragments.include?(fragment) %><%# 門番：見せてはいけない画像ならスキップ %>

          <div class="break-inside-avoid group relative mb-6">
            <div class="relative rounded-2xl overflow-hidden bg-white shadow-sm border border-slate-100 transition-all duration-300 group-hover:-translate-y-1 group-hover:shadow-xl group-hover:shadow-indigo-100/50">
              <%= link_to "", fragment_path(fragment), class: "absolute inset-0 z-10" %>

              <%# ★ 削除ボタン復活：本人の時だけ表示 %>
              <% if user_signed_in? && current_user.id == @collection.user_id %>
                <%= button_to collection_collection_item_path(@collection, item), method: :delete, data: { turbo_confirm: "Remove from Collection?" }, class: "absolute top-2 right-2 z-30 p-2 bg-white/90 backdrop-blur-sm text-slate-400 hover:text-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-all shadow-sm cursor-pointer" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                <% end %>
              <% end %>

              <%# 画像表示 %>
              <% if fragment.image.attached? %>
                <%= image_tag fragment.image, class: "w-full h-auto object-cover" %>
              <% end %>

              <%# ホバー時のオーバーレイ（タイトル ＆ Compareボタン） %>
              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4 z-20 pointer-events-none">
                <h3 class="text-white text-sm font-bold line-clamp-1 mb-1"><%= fragment.title.presence || "Untitled" %></h3>
                
                <div class="flex items-center justify-between">
                  <span class="text-[10px] text-white/80 font-['Space_Grotesk'] uppercase tracking-wider">@<%= fragment.user.username %></span>
                  
                  <%# ★ Compareボタン復活 %>
                  <%= link_to select_comparisons_path(fragment_id: fragment.id), class: "pointer-events-auto p-2 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white hover:text-indigo-600 transition-all shadow-lg hover:scale-110", title: "Compare in Studio" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8.5 2h7" /><path stroke-linecap="round" stroke-linejoin="round" d="M7 16h10" />
                    </svg>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

      </div>
    <% else %>
      <%# コレクションが空、または閲覧権限のある画像がない場合 %>
      <div class="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-200">
        <p class="font-bold text-slate-400 text-sm">No visible fragments in this Collection.</p>
      </div>
    <% end %>
  </div>
</div>