<div class="w-full max-w-7xl mx-auto px-4 pb-20">
  
  <%# --- 1. プロフィールヘッダー --- %>
  <div class="flex flex-col items-center text-center mb-12 pt-10">
    <div class="relative w-24 h-24 mb-6 group">
      <div class="w-24 h-24 rounded-full overflow-hidden border border-indigo-100 shadow-xl shadow-indigo-100/50 bg-white">
        <% if @user&.avatar&.attached? %>
          <%= image_tag @user.avatar, class: "w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" %>
        <% else %>
          <div class="w-full h-full bg-gradient-to-br from-indigo-50 to-white flex items-center justify-center text-4xl font-['Poppins'] font-bold text-indigo-600">
            <%= @user&.username&.first&.upcase || "?" %>
          </div>
        <% end %>
      </div>
      
      <% if current_user == @user %>
        <%= link_to edit_user_registration_path, class: "absolute bottom-0 right-0 bg-white text-slate-400 p-1.5 rounded-full border border-slate-200 shadow-sm hover:text-indigo-600 hover:border-indigo-200 transition-colors" do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
        <% end %>
      <% end %>
    </div>

    <div class="mb-3">
      <span class="bg-indigo-50 text-indigo-600 border border-indigo-100 text-[10px] px-3 py-1 rounded-full font-['Poppins'] font-bold tracking-widest uppercase">
        CREATOR
      </span>
    </div>

    <h1 class="font-['Poppins'] text-3xl font-bold text-slate-900">
      @<%= @user&.username %>
    </h1>
    <p class="mt-2 text-sm text-slate-500 font-['Inter']">
      Morphe0 Studio Member
    </p>

    <div class="flex gap-3 mt-6 justify-center"> 
      <% if current_user != @user %>
        <% if user_signed_in? && current_user.teammate_with?(@user) %>
          <button class="px-6 py-2 bg-indigo-50 text-indigo-600 rounded-full font-['Poppins'] font-bold text-xs border border-indigo-100 flex items-center gap-2">
            <span>TEAMMATE ⚡️</span>
          </button>
          <% rel = Relationship.find_by(follower: current_user, followed: @user) || Relationship.find_by(follower: @user, followed: current_user) %>
          <% if rel %>
            <%= button_to relationship_path(rel), method: :delete, class: "w-8 h-8 rounded-full border border-slate-200 text-slate-400 hover:text-red-500 hover:border-red-200 flex items-center justify-center transition-colors", title: "Leave Team" do %>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
            <% end %>
          <% end %>
        <% else %>
          <% existing_request = user_signed_in? ? Relationship.find_by(follower: current_user, followed: @user) : nil %>
          <% if existing_request && existing_request.pending? %>
            <button class="px-6 py-2 bg-slate-100 text-slate-500 rounded-full font-['Poppins'] font-bold text-xs cursor-default">REQUEST SENT</button>
          <% else %>
            <%= button_to relationships_path(followed_id: @user&.id), class: "px-6 py-2 bg-slate-900 text-white rounded-full font-['Poppins'] font-bold text-xs hover:bg-indigo-600 transition-colors shadow-lg" do %>TEAMMATE<% end %>
          <% end %>
        <% end %>
      <% else %>
        <%= link_to "EDIT PROFILE", edit_user_registration_path, class: "px-6 py-2 border border-slate-200 text-slate-600 rounded-full font-['Poppins'] font-bold text-xs hover:border-slate-400 transition-colors" %>
      <% end %>
    </div>

    <div class="flex gap-10 mt-8 pt-6 px-10">
      <div class="text-center">
        <span class="block font-['Poppins'] font-bold text-xl text-slate-900"><%= @user&.fragments&.count || 0 %></span>
        <span class="text-[10px] text-slate-400 uppercase tracking-widest font-medium">Fragments</span>
      </div>
      <div class="text-center">
        <span class="block font-['Poppins'] font-bold text-xl text-slate-900">
          <% if user_signed_in? && current_user == @user %><%= @user.teammates_count %><% else %><span class="text-slate-300">-</span><% end %>
        </span>
        <span class="text-[10px] text-slate-400 uppercase tracking-widest font-medium">Teammates</span>
      </div>
    </div>
  </div>

  <%# --- 2. COLLECTIONS セクション --- %>
  <div class="mt-2 mb-2.5">
    <div class="flex items-center justify-between mb-6 px-4">
      <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span> Collections
      </h2>
      <% if @user %>
        <%= link_to user_profile_path(@user&.username), class: "text-[10px] font-bold text-slate-400 hover:text-indigo-500 uppercase tracking-wider flex items-center gap-1 transition-colors", data: { turbo_action: "replace" } do %>
          <span>View All</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        <% end %>
      <% end %>
    </div>

    <div class="flex gap-8 overflow-x-auto custom-scrollbar px-4 pb-12 pt-4 min-h-[240px]">
      <%
        is_teammate = user_signed_in? && (current_user.following.include?(@user) || current_user.followers.include?(@user))
        display_collections = if current_user == @user
          @user.collections
        elsif is_teammate
          @user.collections.where(visibility: [:public_view, :teammates_view])
        else
          @user.collections.where(visibility: :public_view)
        end
      %>

      <% display_collections&.each do |collection| %>
        <% 
          visible_frags = if current_user == @user
            collection.fragments
          else
           collection.fragments.where.not(visibility: :private_view)
          end
        %>
        
        <div class="flex-shrink-0 w-40 relative group">
          <% if current_user == @user %>
            <%= link_to collection_path(collection), 
                        data: { turbo_method: :delete, turbo_confirm: "Delete this Collection?" }, 
                        class: "absolute top-1 left-3 z-50 h-5 w-5 inline-flex items-center justify-center bg-rose-50/90 backdrop-blur-sm text-rose-300 hover:bg-rose-100 hover:text-rose-500 rounded-full shadow-sm opacity-0 group-hover:opacity-100 group-hover:rotate-0 -rotate-90 transition-all duration-300 ease-out cursor-pointer no-underline" do %>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-2 w-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18L18 6M6 6l12 12" /></svg>
            <% end %>
          <% end %>

          <%= link_to collection_path(collection), class: "relative block cursor-pointer" do %>
            <div class="relative w-40 h-40">
              <div class="absolute inset-0 bg-white border border-slate-100 shadow-sm rounded-xl transform rotate-6 translate-x-2 translate-y-2 group-hover:rotate-12 group-hover:translate-x-4 transition-all duration-300 ease-out z-0 overflow-hidden">
                <% if visible_frags.offset(2).first&.image&.attached? %><%= image_tag visible_frags.offset(2).first.image, class: "w-full h-full object-cover opacity-50" %><% else %><div class="w-full h-full bg-slate-50"></div><% end %>
              </div>
              <div class="absolute inset-0 bg-white border border-slate-100 shadow-sm rounded-xl transform -rotate-3 translate-x-1 group-hover:-rotate-6 group-hover:-translate-x-2 transition-all duration-300 ease-out z-10 overflow-hidden">
                <% if visible_frags.offset(1).first&.image&.attached? %><%= image_tag visible_frags.offset(1).first.image, class: "w-full h-full object-cover opacity-70" %><% else %><div class="w-full h-full bg-slate-50"></div><% end %>
              </div>
              <div class="absolute inset-0 bg-white border border-slate-200 shadow-md rounded-xl transform group-hover:-translate-y-2 group-hover:shadow-xl transition-all duration-300 ease-out z-20 overflow-hidden">
                <% if visible_frags.first&.image&.attached? %><%= image_tag visible_frags.first.image, class: "w-full h-full object-cover" %><% else %><div class="w-full h-full bg-slate-50 flex items-center justify-center text-indigo-200">?</div><% end %>
                <% if collection.private_view? %>
                  <div class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full backdrop-blur-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg></div>
                <% end %>
              </div>
            </div>
            <div class="mt-4 text-center">
              <h3 class="text-sm font-bold text-slate-800 group-hover:text-indigo-600 transition-colors line-clamp-1"><%= collection.title %></h3>
              <p class="text-[10px] text-slate-400 font-['Space_Grotesk'] mt-0.5"><%= visible_frags.count %> items</p>
            </div>
          <% end %>
        </div>
      <% end %>

      <% if current_user == @user %>
        <%= link_to new_collection_path, class: "group flex-shrink-0 w-40 h-40 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center hover:border-indigo-400 hover:bg-indigo-50 transition-all cursor-pointer" do %>
          <span class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 group-hover:bg-indigo-100 group-hover:text-indigo-500 flex items-center justify-center transition-colors mb-2">＋</span>
          <span class="text-xs font-bold text-slate-400 group-hover:text-indigo-500">New Collection</span>
        <% end %>
      <% end %>
    </div>
  </div>

  <%# --- 3. タブセクション (スクロール固定修正済み) --- %>
  <% if user_signed_in? && current_user == @user %>
    <div class="flex justify-center mb-10" data-controller="profile-tabs">
      <div class="relative flex items-center bg-white/60 backdrop-blur-md border border-white/60 p-1 rounded-full shadow-sm w-64">
        <% background_class = params[:tab].nil? ? 
             "left-1 w-[calc(50%-4px)] bg-indigo-600 shadow-[0_4px_14px_0_rgba(79,70,229,0.39)]" : 
             "left-[calc(50%+4px)] w-[calc(50%-8px)] bg-pink-500 shadow-[0_4px_14px_0_rgba(236,72,153,0.39)]" %>
        
        <div data-profile-tabs-target="background" class="absolute top-1 bottom-1 rounded-full transition-all duration-500 ease-[cubic-bezier(0.23,1,0.32,1)] <%= background_class %>"></div>

        <%= link_to "Creations", user_profile_path(@user.username), 
            data: { 
              action: "click->profile-tabs#switchToCreations", 
              turbo_frame: "profile_content",
              turbo_action: "advance",
              turbo_scroll: false,
              profile_tabs_target: "creationsLink"
            },
            class: "relative z-20 flex-1 text-center py-2 rounded-full text-xs font-['Poppins'] font-bold tracking-widest transition-all duration-500 ease-out #{params[:tab].nil? ? 'text-white' : 'text-slate-400 hover:text-indigo-600'}" %>

        <%= link_to "Saved", user_profile_path(@user.username, tab: 'saved'), 
            data: { 
              action: "click->profile-tabs#switchToSaved", 
              turbo_frame: "profile_content",
              turbo_action: "advance",
              turbo_scroll: false,
              profile_tabs_target: "savedLink"
            },
            class: "relative z-20 flex-1 text-center py-2 rounded-full text-xs font-['Poppins'] font-bold tracking-widest transition-all duration-500 ease-out #{params[:tab] == 'saved' ? 'text-white' : 'text-slate-400 hover:text-pink-600'}" %>
      </div>
    </div>
  <% end %>

  <%# --- 4. FRAGMENTS グリッド --- %>
  <%= turbo_frame_tag "profile_content" do %>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 md:gap-8">
      <% @fragments&.each do |fragment| %>
        <div class="group relative transition-all duration-300 ease-out hover:-translate-y-2 hover:rotate-2">
          <div class="bg-white p-2 rounded-[20px] shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-slate-100 group-hover:shadow-[0_20px_40px_rgb(99,102,241,0.2)] transition-shadow">
            <div class="w-full aspect-[4/5] overflow-hidden rounded-[12px] bg-slate-100 relative mb-3">
              <% if fragment.respond_to?(:private_view?) && fragment.private_view? %>
                <div class="absolute top-2 right-2 z-30 bg-black/80 text-white w-7 h-7 flex items-center justify-center rounded-full backdrop-blur-md shadow-lg border border-white/10"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg></div>
              <% end %>
              <% if fragment.image.attached? %>
                <%= image_tag fragment.image, class: "w-full h-full object-cover" %>
              <% else %><div class="w-full h-full bg-slate-100 flex items-center justify-center font-bold text-slate-300">?</div><% end %>
            </div>
            <div class="px-1 pb-2">
               <h3 class="font-['Poppins'] font-bold text-slate-800 text-sm line-clamp-1 mb-0.5"><%= fragment.title.presence || "Untitled" %></h3>
               <% if fragment.description.present? %><p class="text-[10px] text-slate-400 font-['Inter'] line-clamp-1 mb-2"><%= fragment.description %></p><% end %>
               <div class="flex items-center justify-end mb-2 h-6">
                 <div class="relative z-20 scale-75 origin-right">
                   <% if user_signed_in? %><%= render 'likes/like_button', fragment: fragment %><% end %>
                 </div>
               </div>
               <div class="flex justify-between items-center text-[10px] font-['Inter'] text-slate-500">
                 <span class="bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded-full font-medium truncate max-w-[50%]">@<%= fragment.user.username %></span>
                 <span><%= fragment.created_at.strftime("%Y.%m.%d") %></span>
               </div>
            </div>
          </div>
          <%= link_to "", fragment, class: "absolute inset-0 z-10", data: { turbo_frame: "_top" } %>
        </div>
      <% end %>
    </div>
    <% if @fragments.blank? %>
      <div class="mt-20 flex flex-col items-center justify-center text-center opacity-60 font-['Poppins'] text-slate-500">No fragments here.</div>
    <% end %>
  <% end %> 

</div>