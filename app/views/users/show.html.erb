<div class="w-full max-w-7xl mx-auto px-4 pb-20">
  
  <%# --- 1. プロフィール＆コレクションエリア --- %>
  <div class="flex flex-col lg:flex-row items-stretch gap-10 mb-8 pt-10 border-b border-slate-100 pb-10">
    
    <%# --- 左側：プロフィール情報 --- %>
    <div class="flex flex-col sm:flex-row lg:flex-col items-center sm:items-start lg:items-center gap-6 shrink-0 lg:w-64">
      
      <div class="relative group flex-shrink-0">
        <div class="w-24 h-24 md:w-28 md:h-28 rounded-full overflow-hidden border-4 border-white shadow-xl shadow-slate-200 bg-white">
          <% if @user&.avatar&.attached? %>
            <%= image_tag @user.avatar, class: "w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" %>
          <% else %>
            <div class="w-full h-full bg-gradient-to-br from-indigo-50 to-white flex items-center justify-center text-4xl font-['Poppins'] font-bold text-indigo-300">
              <%= @user&.username&.first&.upcase || "?" %>
            </div>
          <% end %>
        </div>
        
        <% if current_user == @user %>
          <%= link_to edit_user_registration_path, class: "absolute bottom-0 right-0 bg-white text-slate-400 p-2 rounded-full border border-slate-100 shadow-md hover:text-indigo-600 hover:border-indigo-100 transition-colors" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
          <% end %>
        <% end %>
      </div>

      <div class="text-center sm:text-left lg:text-center w-full">
        <div class="flex flex-col sm:flex-row lg:flex-col items-center sm:items-baseline lg:items-center gap-2 mb-2 justify-center sm:justify-start lg:justify-center">
          
          <h1 class="font-['Poppins'] text-3xl font-bold text-slate-900 leading-normal pb-1 truncate max-w-full">
            @<%= @user&.username %>
          </h1>
          
          <span class="bg-indigo-50 text-indigo-600 border border-indigo-100 text-[9px] px-2 py-0.5 rounded-full font-['Poppins'] font-bold tracking-widest uppercase shrink-0">
            Creator
          </span>
        </div>
        
        <p class="text-xs text-slate-500 font-['Inter'] mb-5 line-clamp-2">
          Morphe0 Studio Member
        </p>

        <div class="flex justify-center sm:justify-start lg:justify-center gap-2 flex-wrap"> 
          <% if current_user != @user %>
            <%# --- 他人の場合：Teammateボタン --- %>
            <% if user_signed_in? && current_user.teammate_with?(@user) %>
              <div class="flex items-center gap-2">
                <div class="px-4 py-2 bg-white text-indigo-600 rounded-full font-['Poppins'] font-bold text-xs border border-indigo-100 flex items-center gap-2 shadow-sm select-none">
                  <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
                  </span>
                  <span>TEAMMATE</span>
                </div>
                <% rel = Relationship.find_by(follower: current_user, followed: @user) || Relationship.find_by(follower: @user, followed: current_user) %>
                <% if rel %>
                  <%= button_to relationship_path(rel), method: :delete, class: "group w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 hover:border-red-200 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-all shadow-sm", title: "Leave Team" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 transition-transform group-hover:rotate-90"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                  <% end %>
                <% end %>
              </div>
            <% else %>
              <% existing_request = user_signed_in? ? Relationship.find_by(follower: current_user, followed: @user) : nil %>
              <% if existing_request && existing_request.pending? %>
                <button class="px-6 py-2 bg-slate-50 text-slate-400 border border-slate-200 rounded-full font-['Poppins'] font-bold text-xs cursor-not-allowed flex items-center gap-2 shadow-inner">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  <span>REQUESTING...</span>
                </button>
              <% else %>
                <%= button_to relationships_path(followed_id: @user&.id), class: "group relative px-6 py-2.5 bg-slate-900 text-white rounded-full font-['Poppins'] font-bold text-xs overflow-hidden shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 hover:-translate-y-0.5 transition-all duration-300" do %>
                  <div class="absolute inset-0 w-full h-full bg-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                  <div class="relative flex items-center gap-2">
                    <span>CONNECT</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 group-hover:rotate-12 transition-transform duration-300 text-indigo-300 group-hover:text-white" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                  </div>
                <% end %>
              <% end %>
            <% end %>

          <%# --- 本人の場合：アクションボタン --- %>
          <% else %>
            <%= link_to edit_user_registration_path, class: "group px-5 py-2 border border-slate-200 text-slate-500 rounded-full font-['Poppins'] font-bold text-xs hover:border-indigo-200 hover:text-indigo-600 hover:bg-indigo-50 transition-colors flex items-center gap-2 bg-white" do %>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
              <span>EDIT</span>
            <% end %>

            <% if params[:tab] == 'saved' %>
               <%= link_to user_profile_path(@user.username), class: "group px-4 py-2 border border-slate-200 text-slate-500 rounded-full font-['Poppins'] font-bold text-xs hover:border-indigo-200 hover:text-indigo-600 hover:bg-indigo-50 transition-colors flex items-center gap-2 bg-white", data: { turbo_action: "replace" } do %>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                  <span>CREATIONS</span>
               <% end %>
            <% else %>
               <%= link_to user_profile_path(@user.username, tab: 'saved'), class: "group px-4 py-2 border border-slate-200 text-slate-500 rounded-full font-['Poppins'] font-bold text-xs hover:border-pink-200 hover:text-pink-500 hover:bg-pink-50 transition-colors flex items-center gap-2 bg-white", data: { turbo_action: "replace" } do %>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                  <span>SAVED</span>
               <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <%# --- 右側：コレクション一覧 --- %>
    <div class="flex-1 w-full min-w-0 lg:border-l lg:border-slate-100 lg:pl-10 pt-6 lg:pt-0 flex flex-col justify-center">
      
      <div class="flex items-center justify-between mb-5 px-1">
        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
          <span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span> Collections
        </h2>
        <% if @user %>
          <%= link_to collections_path(username: @user.username), class: "text-[10px] font-bold text-indigo-500 hover:text-indigo-700 uppercase tracking-wider flex items-center gap-1 transition-colors", data: { turbo_frame: "_top" } do %>
            <span>View All</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
          <% end %>
        <% end %>
      </div>

      <div class="flex gap-5 overflow-x-auto custom-scrollbar pb-8 pt-4 px-2 -mx-2 items-start min-h-[190px]">
        <%
          is_teammate = user_signed_in? && (current_user.following.include?(@user) || current_user.followers.include?(@user))
          display_collections = if current_user == @user
            @user.collections
          elsif is_teammate
            @user.collections.where(visibility: [:public_view, :teammates_view])
          else
            @user.collections.where(visibility: :public_view)
          end
        %>

        <% display_collections&.each do |collection| %>
          <% 
            visible_frags = if current_user == @user
              collection.fragments
            else
             collection.fragments.where.not(visibility: :private_view)
            end
          %>
          <div class="flex-shrink-0 w-32 md:w-36 relative group">
            <% if current_user == @user %>
              <%= link_to collection_path(collection), 
                          data: { turbo_method: :delete, turbo_confirm: "Delete this Collection?" }, 
                          class: "absolute -top-3 -right-3 z-50 h-7 w-7 inline-flex items-center justify-center bg-slate-800 text-white rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-all duration-200 cursor-pointer hover:bg-rose-500 hover:scale-110 border-2 border-white" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18L18 6M6 6l12 12" /></svg>
              <% end %>
            <% end %>

            <%= link_to collection_path(collection), class: "block cursor-pointer" do %>
              <div class="relative w-32 h-32 md:w-36 md:h-36 mb-3 overflow-hidden rounded-2xl bg-slate-100 border border-slate-100 group-hover:shadow-md transition-all">
                <% if visible_frags.any? %>
                  <div class="grid grid-cols-2 grid-rows-2 w-full h-full gap-0.5">
                    <div class="row-span-2 relative"><%= image_tag visible_frags[0].image, class: "w-full h-full object-cover" %></div>
                    <div class="relative"><% if visible_frags[1]&.image&.attached? %><%= image_tag visible_frags[1].image, class: "w-full h-full object-cover" %><% else %><div class="w-full h-full bg-slate-50"></div><% end %></div>
                    <div class="relative"><% if visible_frags[2]&.image&.attached? %><%= image_tag visible_frags[2].image, class: "w-full h-full object-cover" %><% else %><div class="w-full h-full bg-slate-50"></div><% end %></div>
                  </div>
                <% else %>
                  <div class="w-full h-full flex items-center justify-center text-slate-300 font-bold text-xl"><%= collection.title.first.upcase rescue "?" %></div>
                <% end %>
                <% if collection.private_view? %>
                  <div class="absolute top-2 right-2 bg-black/60 text-white p-1 rounded-full backdrop-blur-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg></div>
                <% end %>
              </div>
              <div class="text-center px-1">
                <h3 class="text-xs font-bold text-slate-800 group-hover:text-indigo-600 transition-colors line-clamp-1"><%= collection.title %></h3>
                <p class="text-[9px] text-slate-400 font-['Space_Grotesk'] mt-1"><%= visible_frags.count %> items</p>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if current_user == @user %>
          <%= link_to new_collection_path, class: "group flex-shrink-0 w-32 h-32 md:w-36 md:h-36 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center hover:border-indigo-400 hover:bg-indigo-50/50 transition-all cursor-pointer" do %>
            <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 group-hover:bg-indigo-100 group-hover:text-indigo-500 flex items-center justify-center transition-colors mb-2 shadow-sm">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
            </div>
            <span class="text-[10px] font-bold text-slate-400 group-hover:text-indigo-500 uppercase tracking-wide">New Album</span>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <%# --- 2. メイングリッド (Tabsなし) --- %>
  <%= turbo_frame_tag "profile_content" do %>
    
    <%# Saved表示時だけタイトルを表示して、ユーザーに知らせる %>
    <% if params[:tab] == 'saved' %>
      <div class="flex items-center gap-2 mb-6 text-pink-500 font-['Poppins'] font-bold text-sm tracking-widest uppercase">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
        <span>Saved Items</span>
      </div>
    <% end %>

    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
      <% @fragments&.each do |fragment| %>
        <div class="group relative aspect-square bg-slate-200 rounded-xl overflow-hidden cursor-pointer shadow-sm hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
          <% if fragment.image.attached? %>
            <%= image_tag fragment.image, class: "w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-110" %>
          <% else %>
            <div class="w-full h-full bg-slate-100 flex items-center justify-center font-bold text-slate-300 text-xl">?</div>
          <% end %>
          <% if fragment.respond_to?(:private_view?) && fragment.private_view? %>
            <div class="absolute top-2 right-2 z-20 bg-black/60 text-white w-5 h-5 flex items-center justify-center rounded-full backdrop-blur-md shadow-sm border border-white/20">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-2.5 h-2.5"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
            </div>
          <% end %>
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/10 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 flex flex-col justify-end p-3 z-10">
            <h3 class="text-white font-['Poppins'] font-bold text-xs line-clamp-1 translate-y-4 group-hover:translate-y-0 transition-transform duration-300 drop-shadow-md mb-1"><%= fragment.title.presence || "Untitled" %></h3>
            <div class="flex items-center justify-between mt-1 translate-y-4 group-hover:translate-y-0 transition-transform duration-300 delay-75">
              <div class="flex items-center gap-1.5"><span class="text-[9px] text-white/90 font-['Space_Grotesk']">@<%= fragment.user.username %></span></div>
              <div class="scale-75 relative z-20 text-white origin-right"><% if user_signed_in? %><%= render 'likes/like_button', fragment: fragment %><% end %></div>
            </div>
            <%= link_to "", fragment, class: "absolute inset-0 z-0", data: { turbo_frame: "_top" } %>
          </div>
        </div>
      <% end %>
    </div>
    
    <% if @fragments.blank? %>
      <div class="mt-20 flex flex-col items-center justify-center text-center opacity-60">
        <p class="font-['Poppins'] text-slate-400 font-medium text-sm">No fragments found.</p>
      </div>
    <% end %>
  <% end %> 

</div>